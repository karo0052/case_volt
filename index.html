<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="css/main.scss" />
    <title>Roskilde Festival - Volt</title>
  </head>
  <body>
    <form>
      <!-------------------------------------------- KURV -------------------------------------------->
      <h2>Services</h2>
      <label>
        <input
          type="number"
          name="persons"
          id="number_persons"
          value="1"
          min="1"
          max="20"
          required
        />
        Personer
      </label>
      <p class="total_services">
        <span id="amount_service">1</span> x VoltSwap-bytteservice
      </p>
      <p class="price_services">179 DKK</p>
      <p class="total_chargers">
        <span id="amount_chargers">1</span> x Volt-opladere (depositum)
      </p>
      <p class="price_chargers">200 DKK</p>

      <div class="single_person">
        <p>Har du allerede en Volt-oplader?</p>
        <label>
          <input type="checkbox" name="charger_single" id="own_charger" /> Jeg
          medbringer egen Volt-oplader
        </label>
      </div>
      <div class="multiple_persons">
        <p>Har en eller flere af jer allerede en Volt-oplader?</p>
        <label>
          <input
            type="number"
            name="charger_number"
            id="set_chargers"
            value="0"
            min="0"
          />
          Medbringer selv en Volt-oplader
        </label>
        <div class="advarsel">
          <p>
            Antal medbragte opladere kan ikke være højere end antal personer!
          </p>
        </div>
      </div>

      <!-------------------------------------------- KURV SLUT-------------------------------------------->

      <!-------------------------------------------- LEVERING -------------------------------------------->
      <h2>Levering</h2>

      <label>
        <input type="radio" name="delivery" id="delivery_afhentning" checked />
        <span class="afhentning_tekst"
          >Afhentning på festivalen eller hos Volt</span
        >
      </label>
      <p class="afhentning_pris">Gratis</p>
      <label>
        <input type="radio" name="delivery" id="delivery_posthus" />
        <span class="posthus_tekst">Levering til posthus</span>
      </label>
      <p class="posthus_pris">50 DKK</p>
      <!-------------------------------------------- LEVERING SLUT -------------------------------------------->

      <!-------------------------------------------- ORDREOVERSIGT -------------------------------------------->
      <h2>Ordreoversigt</h2>
      <div class="order_services"></div>
      <div class="order_chargers"></div>
      <div class="order_delivery"></div>

      <!-------------------------------------------- ORDREOVERSIGT SLUT-------------------------------------------->

      <!-------------------------------------------- OPLYSNINGER -------------------------------------------->
      <h2>Oplysninger</h2>
      <label>
        Fornavn
        <input type="text" name="firstname" placeholder="Mikkel" required />
      </label>
      <br />
      <label>
        Efternavn
        <input type="text" name="lastname" placeholder="Jensen" required />
      </label>
      <br />
      <div class="delivery">
        <label>
          Vejnavn + nummer
          <input
            type="text"
            name="address"
            class="autofill"
            placeholder="Vej 1"
            value="null"
            required
          />
        </label>
        <br />
        <label>
          Postnummer
          <input
            type="number"
            name="zip"
            class="autofill_number"
            placeholder="1234"
            value="1234"
            required
          />
        </label>
        <br />
        <label>
          By
          <input
            type="text"
            name="city"
            class="autofill"
            placeholder="Vejstrup"
            value="null"
            required
          />
        </label>
        <br />
      </div>
      <label>
        E-mail
        <input
          type="text"
          name="email"
          placeholder="mikkel_jensen@mail.dk"
          required
        />
      </label>
      <!-------------------------------------------- OPLYSNINGER SLUT -------------------------------------------->

      <!-------------------------------------------- BETALING -------------------------------------------->
      <h2>Ordreoversigt</h2>
      <div class="order_services"></div>
      <div class="order_chargers"></div>
      <div class="order_delivery"></div>

      <h2>Vælg betalingsmetode</h2>
      <label>
        Kortbetaling
        <input type="radio" name="payment" id="payment_kort" checked />
      </label>
      <label>
        Mobilepay
        <input type="radio" name="payment" id="payment_mobilepay" />
      </label>
      <label>
        Paypal
        <input type="radio" name="payment" id="payment_paypal" />
      </label>
      <br />
      <br />
      <input class="add_button" type="submit" value="Gå til betaling" />

      <!-------------------------------------------- BETALING SLUT-------------------------------------------->
    </form>

    <script src="index.js"></script>
    <script>
      "use strict";
      document.addEventListener("DOMContentLoaded", init);

      let input_persons = 1;
      let number_chargers = input_persons;
      let chosen_delivery = "afhentning";
      const form = document.querySelector("form");

      // init funktion med eventlisteners
      function init() {
        console.log("init");

        document
          .querySelector("#number_persons")
          .addEventListener("input", updatePersons);

        document
          .querySelector("#own_charger")
          .addEventListener("change", updateChargers);

        document
          .querySelector("#set_chargers")
          .addEventListener("input", updateChargersGroups);

        document
          .querySelector("#delivery_posthus")
          .addEventListener("change", updateDeliveryPosthus);

        document
          .querySelector("#delivery_afhentning")
          .addEventListener("change", updateDeliveryAfhentning);

        setServices();
      }

      function updatePersons(e) {
        console.log("updatePersons");

        input_persons = parseInt(e.target.value);
        // forhindrer at der står NaN, når inputfeltet er tomt, ved at indsætte 0
        if (e.target.value == "" || e.target.value < 0) {
          input_persons = 0;
        }
        number_chargers = input_persons;
        // indsæt her
        document.querySelector("#set_chargers").value = 0;
        setServices();
      }

      function updateChargers(e) {
        console.log("updateChargers");

        if (e.target.checked == true) {
          number_chargers = number_chargers - number_chargers;
        } else {
          number_chargers = input_persons;
        }

        setServices();
      }

      function updateChargersGroups(e) {
        console.log("updateChargersGroups");
        const input_chargers = parseInt(e.target.value);

        if (e.target.value == "" || e.target.value < 0) {
          number_chargers = input_persons;
        } else if (input_chargers > input_persons) {
          console.log("too much");
          number_chargers = input_persons;
          document.querySelector(".advarsel").style.visibility = "visible";
          document.querySelector(".advarsel").style.height = "auto";
          document.querySelector("#set_chargers").style.outline =
            "1px solid red";
          setTimeout(function() {
            console.log("tiden er gået");
            document.querySelector("#set_chargers").value = input_persons;
            document.querySelector("#set_chargers").style.outline = "none";
            document.querySelector(".advarsel").style.visibility = "hidden";
            document.querySelector(".advarsel").style.height = "0";
          }, 2500);
        } else {
          number_chargers = input_persons - input_chargers;
        }
        setServices();
      }

      function updateDeliveryPosthus(e) {
        console.log("updateDeliveryPosthus");

        if (e.target.checked == true) {
          chosen_delivery = "posthus";
          document.querySelector(".delivery").style.visibility = "visible";
          document.querySelector(".delivery").style.height = "auto";
          document.querySelectorAll(".autofill").forEach(felt => {
            felt.value = null;
          });
          document.querySelector(".autofill_number").value = null;
        }
        setServices();
      }

      function updateDeliveryAfhentning(e) {
        console.log("updateDeliveryAfhentning");

        if (e.target.checked == true) {
          chosen_delivery = "afhentning";
          document.querySelector(".delivery").style.visibility = "hidden";
          document.querySelector(".delivery").style.height = "0";
          document.querySelectorAll(".autofill").forEach(felt => {
            felt.value = "null";
          });
          document.querySelector(".autofill_number").value = 1234;
        }
        setServices();
      }

      function setServices() {
        console.log("setServices");

        // skriver antal personer ind og udregner prisen
        document.querySelector("#amount_service").innerHTML = input_persons;
        document.querySelector(".price_services").innerHTML =
          input_persons * 179 + " DKK";
        // sørger for at der meldes fejl, hvis man forsøger at medbringe flere opaldere end man køber tjenester
        document.querySelector("#set_chargers").max = input_persons;
        // hvis der er mere end en person skifter boksen
        if (input_persons > 1) {
          document.querySelector(".multiple_persons").style.visibility =
            "visible";
          document.querySelector(".multiple_persons").style.height = "auto";
          document.querySelector(".single_person").style.visibility = "hidden";
          document.querySelector(".single_person").style.height = "0";
        } else {
          document.querySelector(".multiple_persons").style.visibility =
            "hidden";
          document.querySelector(".single_person").style.visibility = "visible";
        }

        setChargers();
      }

      function setChargers() {
        console.log("setChargers");

        // indsætter som udgangspunkt samme antal depositum som antal service, samt udregner prisen
        document.querySelector("#amount_chargers").innerHTML = number_chargers;
        document.querySelector(".price_chargers").innerHTML =
          number_chargers * 200 + " DKK";

        showOrder();
      }

      function showOrder() {
        console.log("showOrder");
        // indsætter antal services + pris
        document.querySelectorAll(".order_services").forEach(felt => {
          felt.innerHTML =
            document.querySelector(".total_services").innerHTML +
            document.querySelector(".price_services").innerHTML;
        });

        // indsætter antal opladere + pris
        document.querySelectorAll(".order_chargers").forEach(felt => {
          felt.innerHTML =
            document.querySelector(".total_chargers").innerHTML +
            document.querySelector(".price_chargers").innerHTML;
        });

        // indsætter den valgte levering + pris
        if (chosen_delivery == "afhentning") {
          document.querySelectorAll(".order_delivery").forEach(felt => {
            felt.innerHTML =
              document.querySelector(".afhentning_tekst").innerHTML +
              document.querySelector(".afhentning_pris").innerHTML;
          });
        }
        if (chosen_delivery == "posthus") {
          document.querySelectorAll(".order_delivery").forEach(felt => {
            felt.innerHTML =
              document.querySelector(".posthus_tekst").innerHTML +
              document.querySelector(".posthus_pris").innerHTML;
          });
        }
      }

      function post(newCustomer) {
        console.log("post");

        const postData = JSON.stringify(newCustomer);
        fetch("https://friends-a7f9.restdb.io/rest/volt", {
          method: "post",
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "x-apikey": "5c7ceca0cac6621685acbada",
            "cache-control": "no-cache"
          },
          body: postData
        })
          .then(res => res.json())
          .then(data => {
            form.reset();
          });
      }

      document.querySelector("form").addEventListener("submit", e => {
        console.log("submitted");
        e.preventDefault();

        const payload = {
          persons: form.elements.persons.value,
          charger_single: form.elements.charger_single.checked,
          charger_number: form.elements.charger_number.value,
          delivery_afhentning: form.elements.delivery_afhentning.checked,
          delivery_posthus: form.elements.delivery_posthus.checked,
          firstname: form.elements.firstname.value,
          lastname: form.elements.lastname.value,
          address: form.elements.address.value,
          zip: form.elements.zip.value,
          city: form.elements.city.value,
          email: form.elements.email.value,
          payment_kort: form.elements.payment_kort.checked,
          payment_mobilepay: form.elements.payment_mobilepay.checked,
          payment_paypal: form.elements.payment_paypal.checked
        };
        post(payload);
      });
    </script>
  </body>
</html>
